<main class="container">
  <div class="booking-card">
    <h1 class="booking-title">Pagamento</h1>

    <!-- Flight summary -->

    <div *ngIf="loading" class="loading-spinner">Caricamento dettagli volo...</div>

    <div *ngIf="!loading && (!flights || flights.length === 0)" class="error-message">
      <p>Nessun volo trovato per i dettagli specificati.</p>
      <a routerLink="/" class="btn btn-outline">Torna alla ricerca</a>
    </div>
    <ng-container *ngFor="let flight of flights">

      <app-flight-summary [flight]="flight"></app-flight-summary>

      <h2 class="section-title">Riepilogo passeggeri</h2>
      <div class="flight-list">
        <!-- Error if getPassengersByFlight fails? -->
        <div class="flight-item" *ngFor="let it of getPassengersByFlight(flight._id)">
          <div class="flight-details" style="justify-content:space-between;flex-wrap:wrap;">
            <span><strong>{{ it.passenger?.nome }} {{ it.passenger?.cognome }}</strong></span>
            <span>Classe: <strong>{{ it.seat_type?.type || it.seat_type?.seat_class || 'ECONOMY' }}</strong></span>
            <span>Bagaglio: <strong>{{ it.bag_label }}</strong></span>
            <span>Posto: <strong>{{ it.seat_label || 'Casuale / assegnato più tardi' }}</strong></span>
            <span *ngIf="it.seat_fee && it.seat_fee > 0">Sovrapprezzo posto: <strong>€{{ it.seat_fee.toFixed(2)
                }}</strong></span>
            <span>Prezzo: <strong>€{{ it.price.toFixed(2) }}</strong></span>
          </div>
        </div>
      </div>
      <div class="divider"></div>
    </ng-container>



    <div class="summary-item" style="justify-content:flex-end;">
      <span class="summary-label" style="min-width:auto;margin-right:.5rem;">Totale:</span>
      <span class="summary-value" style="font-weight:700;">€{{ total.toFixed(2) }}</span>
    </div>

    <div class="divider"></div>

    <h2 class="section-title">Dati di pagamento</h2>
    <form class="airline-form" (submit)="pay(); $event.preventDefault();">
      <div class="form-group">
        <label for="cc_name">Nome sulla carta</label>
        <input id="cc_name" name="cc_name" placeholder="Mario Rossi" required />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="cc_number">Numero carta</label>
          <input id="cc_number" name="cc_number" inputmode="numeric" autocomplete="cc-number"
            placeholder="1234 5678 9012 3456" required />
        </div>
        <div class="form-group">
          <label for="cc_cvv">CVV</label>
          <input id="cc_cvv" name="cc_cvv" inputmode="numeric" autocomplete="cc-csc" placeholder="123" required />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="cc_exp_month">Mese scadenza</label>
          <select id="cc_exp_month" name="cc_exp_month" required>
            <option value="">MM</option>
            <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">{{ ('0' + m).slice(-2) }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="cc_exp_year">Anno scadenza</label>
          <select id="cc_exp_year" name="cc_exp_year" required>
            <option value="">YYYY</option>
            <option *ngFor="let y of [2025,2026,2027,2028,2029,2030,2031,2032]" [value]="y">{{ y }}</option>
          </select>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" type="submit" [disabled]="loading">Paga €{{ total.toFixed(2) }}</button>
        <a class="btn btn-outline" href="#" (click)="goBack($event)">Annulla</a>
      </div>
      <div *ngIf="error" class="flash-messages">
        <div class="flash-message">{{ error }}</div>
      </div>
    </form>
  </div>
</main>