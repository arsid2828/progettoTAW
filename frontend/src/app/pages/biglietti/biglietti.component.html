<main class="container">
  <div class="search-card">
    <h1 class="page-title">I miei voli</h1>

    <form class="flight-search-form" style="margin-bottom:1rem">
      <div class="form-row">
        <div class="form-group" style="min-width:220px">
          <label for="sort">Ordina per</label>
          <select id="sort" name="sort" (change)="sortTickets($any($event.target).value)">
            <option value="asc">Data di partenza (dal più vicino)</option>
            <option value="desc">Data di partenza (dal più lontano)</option>
          </select>
        </div>
      </div>
    </form>

    <div *ngIf="trips && trips.length > 0; else noTickets">
      <div class="flight-list" id="flight-list">
        <!-- Iterate over TRIPS instead of tickets -->
        <div class="flight-card" *ngFor="let trip of trips" [attr.data-date]="trip.startDate">

          <!-- Trip Header: A -> C -->
          <div class="flight-header trip-header">
            <span class="airline">{{ trip.segments[0].flight?.airline?.name }}</span>
            <span class="flight-route">
              {{ trip.segments[0].flight?.from_airport?.name }} ({{ trip.segments[0].flight?.from_airport?.code }})
              →
              <!-- Final destination of the trip -->
              {{ trip.segments[trip.segments.length - 1].flight?.to_airport?.name }} ({{
              trip.segments[trip.segments.length - 1].flight?.to_airport?.code }})
            </span>

            <!-- Stopovers badge -->
            <span *ngIf="trip.segments.length > 1" class="stops-badge">
              {{ trip.segments.length - 1 }} Scal{{ trip.segments.length - 1 === 1 ? 'o' : 'i' }}
            </span>
          </div>

          <!-- Trip Meta -->
          <div class="flight-details">
            <span class="flight-date">{{ trip.startDate | date:'dd MMMM yyyy' }}</span>
            <span class="flight-time">
              {{ trip.startDate | date:'HH:mm' }}
              →
              {{ trip.endDate | date:'HH:mm dd/MM' }}
            </span>
          </div>
          <div class="flight-details">
            <span>Totale: <strong>{{ trip.totalPrice | currency:'EUR':'symbol':'1.0-2' }}</strong></span>
            <span>Passeggero: <strong>{{ trip.passengerName }}</strong></span>
          </div>

          <!-- Segments Detail (toggleable or always visible? Let's make visible with divider) -->
          <div class="trip-segments">
            <div class="segment-row" *ngFor="let seg of trip.segments; let i = index">
              <hr *ngIf="i > 0" class="segment-divider">
              <div class="segment-info">
                <span class="seg-route">
                  <strong>{{ seg.flight?.from_airport?.code }}</strong>
                  ({{ seg.flight?.departure }})
                  →
                  <strong>{{ seg.flight?.to_airport?.code }}</strong>
                  ({{ seg.flight?.arrival }})
                </span>
                <span class="seg-meta">
                  {{ seg.seat_class?.seat_class || 'Economy' }} • Posto: {{ seg.seat_number || 'ND' }} • Bagaglio: {{
                  seg.bagage_choice || 'Standard' }}
                </span>
              </div>
            </div>
          </div>

          <div class="flight-details" style="margin-top:10px; font-size:0.8rem; color:#666;">
            <span>Data prenotazione: {{ trip.segments[0].createdAt | date:'medium' }}</span>
          </div>

        </div>
      </div>
    </div>

    <ng-template #noTickets>
      <div class="no-flights">
        <p>Non hai ancora acquistato voli.</p>
        <p><a class="btn btn-primary" routerLink="/search">Cerca un volo</a></p>
      </div>
    </ng-template>

  </div>
</main>