<main class="container">
  <div class="search-card">
    <h1 class="page-title">I miei voli</h1>

    <form class="flight-search-form" style="margin-bottom:1rem">
      <div class="form-row">
        <div class="form-group" style="min-width:220px">
          <label for="sort">Ordina per</label>
          <select id="sort" name="sort" (change)="sortTickets($any($event.target).value)">
            <option value="asc">Data di partenza (dal più vicino)</option>
            <option value="desc">Data di partenza (dal più lontano)</option>
            <option value="buy_desc">Data acquisto (dal più recente)</option>
            <option value="buy_asc">Data acquisto (dal più vecchio)</option>
          </select>
        </div>
      </div>
    </form>

    <div *ngIf="trips && trips.length > 0; else noTickets">
      <div class="flight-list" id="flight-list">
        <div class="flight-card" *ngFor="let trip of trips" [attr.data-date]="trip.startDate" (click)="openModal(trip)" style="cursor:pointer">
          <div class="flight-card-top">
            <div class="time-block departure">
              <div class="time">{{ trip.startDate | date:'HH:mm' }}</div>
              <div class="date">{{ trip.startDate | date:'dd / MM / yyyy' }}</div>
              <div class="airport">{{ trip.segments[0].flight?.from_airport?.code }}</div>
            </div>

            <div class="route-block">
              <div class="route-line">
                <div class="from">{{ trip.segments[0].flight?.from_airport?.name }} ({{ trip.segments[0].flight?.from_airport?.code }})</div>
                <div class="arrow">→</div>
                <div class="to">{{ trip.segments[trip.segments.length - 1].flight?.to_airport?.name }} ({{ trip.segments[trip.segments.length - 1].flight?.to_airport?.code }})</div>
              </div>
              <div class="stops-and-passenger">
                <span *ngIf="trip.segments.length > 1" class="stops-badge">{{ trip.segments.length - 1 }} Scal{{ trip.segments.length - 1 === 1 ? 'o' : 'i' }}</span>
                <span class="passenger">Passeggero: <strong>{{ trip.passengerName }}</strong></span>
              </div>
            </div>

            <div class="time-block arrival">
              <div class="time">{{ trip.endDate | date:'HH:mm' }}</div>
              <div class="date">{{ trip.endDate | date:'dd / MM / yyyy' }}</div>
              <div class="airport">{{ trip.segments[trip.segments.length - 1].flight?.to_airport?.code }}</div>
            </div>
          </div>

          <div class="flight-summary">
            <div class="airline"><strong>{{ trip.segments[0].flight?.airline?.name }}</strong></div>
            <div class="price">Totale: <span class="amount">{{ trip.totalPrice | currency:'EUR':'symbol':'1.0-2' }}</span></div>
          </div>

          <div class="trip-segments">
            <div class="segment-row" *ngFor="let seg of trip.segments; let i = index">
              <hr *ngIf="i > 0" class="segment-divider">
              <div class="segment-info">
                <div class="seg-times">
                  <div class="seg-time">{{ seg.flight?.departure | date:'dd / MM / yyyy, HH:mm' }}</div>
                  <div class="seg-airports"><strong>{{ seg.flight?.from_airport?.code }}</strong> → <strong>{{ seg.flight?.to_airport?.code }}</strong></div>
                  <div class="seg-arrival">{{ seg.flight?.arrival | date:'dd / MM / yyyy, HH:mm' }}</div>
                </div>
                <div class="seg-meta">
                  <div>{{ seg.seat_class?.seat_class || 'Economy' }}</div>
                  <div>Posto: <strong>{{ seg.seat_number || 'ND' }}</strong></div>
                  <div>Bagaglio: <strong>{{ seg.bagage_choice || 'Standard' }}</strong></div>
                </div>
              </div>
            </div>
          </div>

          <div class="booking-date">Data prenotazione: {{ trip.segments[0].createdAt | date:'medium' }}</div>
        </div>
      </div>
    </div>

    <ng-template #noTickets>
      <div class="no-flights">
        <p>Non hai ancora acquistato voli.</p>
        <p><a class="btn btn-primary" routerLink="/search">Cerca un volo</a></p>
      </div>
    </ng-template>
  </div>

  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-ticket" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeModal()">×</button>

      <div class="modal-content">
        <div class="modal-left">
          <h3 class="modal-route">
            {{ selectedTrip?.segments[0]?.flight?.from_airport?.code }} → {{ selectedTrip?.segments[selectedTrip.segments.length-1]?.flight?.to_airport?.code }}
          </h3>
          <div class="modal-times">
            Partenza: {{ selectedTrip?.startDate | date:'dd / MM / yyyy, HH:mm' }} — Arrivo: {{ selectedTrip?.endDate | date:'dd / MM / yyyy, HH:mm' }}
          </div>
          <div class="modal-airline">{{ selectedTrip?.segments[0].flight?.airline?.name }}</div>
          <div class="modal-pass">Passeggero: <strong>{{ selectedTrip?.passengerName }}</strong></div>
          <div class="modal-price">Totale: <strong>{{ selectedTrip?.totalPrice | currency:'EUR':'symbol':'1.0-2' }}</strong></div>
        </div>

        <div class="modal-right" [class.multi]="(qrDataList?.length || 0) > 1">
          <div class="qr-stack">
            <div class="qr-item" *ngFor="let qr of qrDataList; let i = index">
              <img [src]="qr" alt="QR" class="modal-qr" />
              <div class="qr-caption">
                {{ selectedTrip?.segments?.[i]?.flight?.from_airport?.code }} → {{ selectedTrip?.segments?.[i]?.flight?.to_airport?.code }}
              </div>
            </div>
          </div>
          <div class="qr-note">QR non funzionante — prototipo</div>
        </div>
      </div>

      <div class="modal-segments">
        <div *ngFor="let seg of selectedTrip?.segments" class="modal-seg">
          <div class="seg-info">{{ seg.flight?.from_airport?.code }} → {{ seg.flight?.to_airport?.code }}</div>
          <div class="seg-meta">{{ seg.flight?.date_departure | date:'dd / MM / yyyy, HH:mm' }} • {{ seg.seat_class?.seat_class || 'Economy' }} • Posto: {{ seg.seat_number || 'ND' }}</div>
        </div>
      </div>
    </div>
  </div>
</main>
